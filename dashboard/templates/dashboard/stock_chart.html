<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dashboard financiero para visualizar gr√°ficos y noticias de acciones en tiempo real.">
    <title>Dashboard Financiero</title>
    
    {% load static %}
    <link rel="stylesheet" href="{% static 'dashboard/styles.css' %}">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>

<body>
    
    <header>
        <nav class="navbar">
            <button class="hamburger" onclick="toggleMenu()">‚ò∞</button>
            <div>
                <ul id="nav-links">
                    <li class="nav-item"><a href="#">Inicio</a></li>
                    <li class="nav-item"><a href="#search-ticker">Gr√°fico</a></li>
                    <li class="nav-item"><a href="#comparador">Comparar</a></li>
                    <li class="nav-item"><a href="#news-widget">Noticias</a></li>
                    <li class="nav-item"><a href="contacto/">Contacto</a></li>
                </ul>
            </div>
            <label class="switch">
                <input type="checkbox" id="theme-toggle"  aria-label="Alternar entre modo claro y oscuro">
                <span class="slider">
                    <span class="icon-moon">üåô</span>
                    <span class="icon-sun">üåû</span>
                </span>
            </label>
        </nav>
    </header>

   
<section class="hero">
    <div class="hero-content">
        <h1 class="hero-title">Explor√° los mercados con poderosas herramientas</h1>
        <p class="hero-subtitle">Visualiz√° datos financieros en tiempo real y tom√° decisiones informadas. Prob√° nuestro dashboard gratuito hoy mismo.</p>
        <a href="#stock-form" class="cta-button">Empezar ahora</a>
    </div>
</section>
    
<div class="glass-divider"></div>

    <main class="container" id="search-ticker">
        <h1>Inserte un ticker para empezar</h1>

        <form method="get" id="stock-form">
            <div style="position: relative; width: 300px; display: inline-block; ">
                <label for="ticker">Ticker:</label>
                <input type="text" id="ticker" name="ticker" placeholder="Ej: AAPL, TSLA, MELI" autocomplete="on"
                    required style="width: 100%;" value="{{ ticker }}">
                <div id="suggestions"></div>
            </div>
            
            <div style="display: flex; flex-direction: column; margin-left: 5px;">
                <label for="period">Periodo:</label>
                <select name="period" onchange="document.getElementById('stock-form').submit();">
                    <option value="1d" {% if timeframe == "1d" %}selected{% endif %}>1 D√≠a</option>
                    <option value="1wk" {% if timeframe == "1wk" %}selected{% endif %}>1 Semana</option>
                    <option value="1mo" {% if timeframe == "1mo" %}selected{% endif %}>1 Mes</option>
                    <option value="1y" {% if timeframe == "1y" %}selected{% endif %}>1 A√±o</option>
                </select>
            </div>
        </form>

        
        
        <h2><strong>Gr√°fico de:</strong> {{ company_name }}</h2>

        <div class="chart-container">
            <!-- Widget de TradingView -->
            <div id="tradingview-widget" style="width: 100%; height: 100%;"></div>
        </div>

        <h2 class ="titulo-news" id="news-widget"><strong>√öltimas noticias:</strong> {{ company_name }}</h2>
        <div class="contenedor-noticias-widget">
    <!-- Noticias -->
    <section style="flex: 2; " aria-labelledby="news-title">
        <div class="news-container">

        <ul class="news-list">
            {% for item in news %}
                <li>
                    <a href="{{ item.link }}" target="_blank">{{ item.title }}</a>
                    <small>{{ item.published }}</small>
                </li>
            {% empty %}
                <li>No hay noticias disponibles.</li>
            {% endfor %}
        </ul>
        </div>
    </section>

    <!-- Widget de An√°lisis T√©cnico -->
    <div style="max-width: 550px; margin: 0 auto;">
  <div class="widget-container">
    <div class="tradingview-widget-container" id="technical-widget-container">
      <div class="tradingview-widget-container__widget"></div>
      <div class="tradingview-widget-copyright">
        <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
          <span class="blue-text">Track all markets on TradingView</span>
        </a>
      </div>
    </div>
  </div>
</div>
   
    </div>
<hr class="full-width">
<section id="comparador" style="margin-top: 100px; margin-bottom: 100px;">
    <h2>üìä Comparador de Empresas</h2>
    <form method="get">
        <label for="tickers">Ingres√° los tickers separados por coma:</label><br>
        <input type="text" name="tickers" placeholder="AAPL, TSLA, MSFT" style="width: 300px;" value="{{ tickers_input }}">
        <input type="hidden" name="ticker" value="{{ ticker }}"> <!-- ‚úÖ Conserva el ticker principal -->
        <button type="submit">Comparar</button>
    </form>

    {% if comparacion %}
    <table class="tabla-comparador">
        <thead>
            <tr>
                <th>Ticker</th>
                <th>Precio</th>
                <th>% Cambio</th>
                <th>Market Cap</th>
                <th>P/E Ratio</th>
                <th style="text-align: center;">Eliminar</th>
            </tr>
        </thead>
        <tbody>
            {% for item in comparacion %}
            <tr>
                <td>{{ item.ticker }}</td>
                <td>{{ item.price }}</td>
                <td class="{% if item.changePercent > 0 %}positivo{% elif item.changePercent < 0 %}negativo{% endif %}">
                    {{ item.changePercent }}%
                </td>
                <td>{{ item.marketCap }}</td>
                <td>{{ item.peRatio }}</td>
                <td style="text-align: center;">
                    {% if item.ticker != ticker %}
                    <a href="?ticker={{ ticker }}&tickers={{ tickers_input|urlencode }}&remove={{ item.ticker }}"
                       class="btn-remove-ticker"
                       title="Eliminar"
                       style="display: inline-block; padding: 4px 8px; background-color: #f44336; color: white; border-radius: 4px; text-decoration: none;">‚úñ</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</section>








</div>
</main>

    
    
    
    
    <footer class="footer">
  <div class="footer-content">
    <a href="https://mi-web-neon-book.reflex.run/" target="_blank">Mi Portfolio</a>
    <a href="https://mi-web-neon-book.reflex.run/financial_page/" target="_blank">Cursos de Trading</a>
  </div>
</footer> 


    <script>
  function toggleMenu() {
    const navLinks = document.getElementById('nav-links');
    navLinks.classList.toggle('active');
  }
</script>

    <script>
  const ticker = "{{ ticker|escapejs }}";
  const interval = "{{ interval}}";

  function getWidgetSize() {
    // Puedes ajustar estos valores seg√∫n tus breakpoints
    if (window.innerWidth < 600) {
      return { width: 320, height: 350 };
    } else if (window.innerWidth < 900) {
      return { width: 420, height: 400 };
    } else {
      return { width: 550, height: 450 };
    }
  }

  function loadTradingViewWidget() {
    const { width, height } = getWidgetSize();
    const script = document.createElement('script');
    script.src = "https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js";
    script.async = true;
    script.innerHTML = JSON.stringify({
      interval: "1m",
      width: width,
      isTransparent: false,
      height: height,
      symbol: ticker,
      showIntervalTabs: true,
      locale: "es",
      colorTheme: "dark"
    });
    const container = document.querySelector("#technical-widget-container .tradingview-widget-container__widget");
    container.innerHTML = '';
    container.appendChild(script);
  }

  // Cargar al inicio
  loadTradingViewWidget();
  // Volver a cargar si cambia el tama√±o de la ventana
  window.addEventListener('resize', function() {
    loadTradingViewWidget();
  });
</script>
    
    <script>
        const tickerInput = document.getElementById('ticker');
        const suggestionsBox = document.getElementById('suggestions');

        // Funci√≥n debounce para evitar m√∫ltiples requests
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Evento input con debounce
        tickerInput.addEventListener('input', debounce(async function () {
            const query = this.value.trim();

            if (query.length < 1) {
                suggestionsBox.innerHTML = '';
                return;
            }

            suggestionsBox.innerHTML = '<div>Cargando...</div>';

            try {
                const response = await fetch(`/autocomplete/?query=${query}`);
                const data = await response.json();

                suggestionsBox.innerHTML = '';
                data.slice(0, 3).forEach(item => {
                    const div = document.createElement('div');
                    div.textContent = `${item.symbol} - ${item.description}`;
                    div.style.padding = '8px';
                    div.style.cursor = 'pointer';
                    div.addEventListener('click', () => {
                        tickerInput.value = item.symbol;
                        suggestionsBox.innerHTML = '';
                        window.location.href = `/?ticker=${item.symbol}`;
                    });
                    suggestionsBox.appendChild(div);
                });
            } catch (error) {
                suggestionsBox.innerHTML = '<div>Error al buscar</div>';
                console.error(error);
            }
        }, 200)); // 300 ms de espera

        // Ocultar sugerencias al hacer clic fuera
        document.addEventListener('click', function (e) {
            if (!suggestionsBox.contains(e.target) && e.target !== tickerInput) {
                suggestionsBox.innerHTML = '';
            }
        });
    </script>

    <script>
        const toggle = document.getElementById('theme-toggle');
        const body = document.body;

        // Guardar preferencia del usuario
        toggle.addEventListener('change', () => {
            if (toggle.checked) {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                localStorage.setItem('theme', 'light');
            }
        });

        // Al cargar la p√°gina, usar preferencia previa
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            body.classList.add(savedTheme + '-mode');
            toggle.checked = savedTheme === 'dark';
        });
    </script>
<script>
// Carga diferida del script de TradingView solo cuando el widget es visible
function loadTradingViewScript(callback) {
  if (window.TradingView) {
    callback();
    return;
  }
  var script = document.createElement('script');
  script.src = 'https://s3.tradingview.com/tv.js';
  script.async = true;
  script.onload = callback;
  document.body.appendChild(script);
}

function showTradingViewWidget() {
  loadTradingViewScript(function() {
    new TradingView.widget({
      "container_id": "tradingview-widget",
      "autosize": true,
      "symbol": "{{ ticker }}",
      "interval": "{{ interval }}",
      "timezone": "Etc/UTC",
      "theme": "dark",
      "style": "1",
      "locale": "es",
      "toolbar_bg": "#f1f3f6",
      "enable_publishing": false,
      "allow_symbol_change": true,
      "save_image": false,
      "hide_side_toolbar": false,
      "show_popup_button": true,
      "popup_width": "1020",
      "popup_height": "500"
    });
  });
}

// Solo carga el widget cuando el usuario hace scroll cerca del gr√°fico
window.addEventListener('DOMContentLoaded', function() {
  var chart = document.getElementById('tradingview-widget');
  var loaded = false;
  function onScroll() {
    if (!loaded && chart.getBoundingClientRect().top < window.innerHeight + 200) {
      loaded = true;
      showTradingViewWidget();
      window.removeEventListener('scroll', onScroll);
    }
  }
  window.addEventListener('scroll', onScroll);
  onScroll(); // Por si ya est√° visible al cargar
});
</script>
<!-- Antes de </body>, agrega este script para mantener la posici√≥n de scroll al eliminar un ticker -->
<script>
  // Guardar la posici√≥n de scroll antes de recargar al eliminar un ticker
  document.querySelectorAll('.btn-remove-ticker').forEach(btn => {
      btn.addEventListener('click', function() {
          localStorage.setItem('scrollPos', window.scrollY);
      });
  });

  // Restaurar la posici√≥n de scroll despu√©s de recargar
  window.addEventListener('DOMContentLoaded', function() {
      const scrollPos = localStorage.getItem('scrollPos');
      if (scrollPos) {
          window.scrollTo(0, parseInt(scrollPos, 10));
          localStorage.removeItem('scrollPos');
      }
  });
</script>
</body>
</html>